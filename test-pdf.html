<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFç”Ÿæˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        h1 {
            color: #2c5282;
        }
        button {
            background-color: #2c5282;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:disabled {
            background-color: #ccc;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #0c5460;
        }
    </style>
</head>
<body>
    <h1>ğŸ“„ PDFç”Ÿæˆãƒ†ã‚¹ãƒˆ</h1>

    <div class="info">
        <strong>ğŸ’¡ ãƒ†ã‚¹ãƒˆå†…å®¹:</strong><br>
        ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰PDFã‚’ç”Ÿæˆã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚<br>
        ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã¯ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‹•ä½œã—ã¾ã™ã€‚
    </div>

    <button onclick="generatePDF()">ğŸ“„ PDFç”Ÿæˆ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <div id="result" style="display: none;"></div>

    <script>
        async function generatePDF() {
            const btn = event.target;
            const resultDiv = document.getElementById('result');

            btn.disabled = true;
            btn.textContent = 'PDFç”Ÿæˆä¸­...';
            resultDiv.style.display = 'none';

            try {
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
                const formData = {
                    lastName: 'å±±ç”°',
                    firstName: 'å¤ªéƒ',
                    lastNameKana: 'ãƒ¤ãƒãƒ€',
                    firstNameKana: 'ã‚¿ãƒ­ã‚¦',
                    postalCode: '877-0000',
                    prefecture: 'å¤§åˆ†çœŒ',
                    city: 'æ—¥ç”°å¸‚',
                    address: 'ç”°å³¶1-1-1',
                    building: 'æ—¥ç”°ãƒãƒ³ã‚·ãƒ§ãƒ³101',
                    phone: '090-1234-5678',
                    email: 'yamada@example.com',
                    immigrantCount: '5',
                    applicantAge: '35',
                    applicantOccupation: 'ä¼šç¤¾å“¡ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰',
                    birthPrefecture: 'æ±äº¬éƒ½',
                    birthCity: 'ä¸–ç”°è°·åŒº',
                    desiredTime: '2026å¹´4æœˆé ƒ',
                    reason: 'è‡ªç„¶è±Šã‹ãªç’°å¢ƒã§å­è‚²ã¦ã‚’ã—ãŸã„',
                    plans: 'å®¶åº­èœåœ’ã‚’å§‹ã‚ãŸã„',
                    employmentType: 'ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç¶™ç¶š',
                    consultation: 'å­è‚²ã¦æ”¯æ´åˆ¶åº¦ã«ã¤ã„ã¦',
                    mailPermission: 'yes',
                    usagePurpose: 'permanent',
                    propertyNumber: 'A-123',
                    transactionType: 'rent',
                    layout: '3LDKä»¥ä¸Š',
                    parkingSpaces: '2',
                    hasPet: 'no',
                    // å®¶æ—ãƒ‡ãƒ¼ã‚¿
                    familyLastName1: 'å±±ç”°',
                    familyFirstName1: 'èŠ±å­',
                    familyLastNameKana1: 'ãƒ¤ãƒãƒ€',
                    familyFirstNameKana1: 'ãƒãƒŠã‚³',
                    familyRelationship1: 'é…å¶è€…',
                    familyAge1: '33',
                    familyOccupation1: 'ãƒ‘ãƒ¼ãƒˆ',
                    familyLastName2: 'å±±ç”°',
                    familyFirstName2: 'ä¸€éƒ',
                    familyLastNameKana2: 'ãƒ¤ãƒãƒ€',
                    familyFirstNameKana2: 'ã‚¤ãƒãƒ­ã‚¦',
                    familyRelationship2: 'å­',
                    familyAge2: '8',
                    familyOccupation2: 'å°å­¦ç”Ÿ',
                };

                console.log('PDFç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡...');

                const response = await fetch('/.netlify/functions/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                resultDiv.style.display = 'block';

                if (response.ok && result.success) {
                    // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const pdfBlob = base64ToBlob(result.pdf, 'application/pdf');
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ç§»ä½ç›¸è«‡_${formData.lastName}${formData.firstName}_${new Date().toISOString().slice(0, 10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `
                        <h3>âœ… PDFç”ŸæˆæˆåŠŸï¼</h3>
                        <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:</strong> ${(result.size / 1024).toFixed(2)} KB</p>
                        <p>PDFãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚</p>
                        <p><small>â€»ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã¯ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‹•ä½œã—ã¾ã™</small></p>
                    `;
                } else {
                    throw new Error(result.message || 'PDFç”Ÿæˆå¤±æ•—');
                }

            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                resultDiv.style.display = 'block';
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h3>âŒ PDFç”Ÿæˆå¤±æ•—</h3>
                    <p>${error.message}</p>
                    <p><small>Netlifyæœ¬ç•ªç’°å¢ƒã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ChromiumãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚</small></p>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“„ PDFç”Ÿæˆ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            }
        }

        // Base64ã‚’Blobã«å¤‰æ›
        function base64ToBlob(base64, contentType) {
            const byteCharacters = atob(base64);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }

            return new Blob(byteArrays, { type: contentType });
        }
    </script>
</body>
</html>
